[databases]
{{with get "/leader"}}{{$leader := .Value}}{{$leadkey := printf "/members/%s" $leader}}{{with get $leadkey}}{{$data := json .Value}}{{$hostport := base (replace (index (split $data.conn_url "/") 2) "@" "/" -1)}}{{ $host := base (index (split $hostport ":") 0)}}{{ $port := base (index (split $hostport ":") 1)}}* = host={{ $host }} port={{ $port }} pool_size=10{{end}}{{end}}

[pgbouncer]
logfile = /var/log/pgbouncer/pgbouncer-[[ item.key ]].log
pidfile = /var/run/pgbouncer/pgbouncer-[[ item.key ]].pid

listen_addr = *
listen_port = [[ item.value.port + 1000 ]]

unix_socket_dir = /var/run/postgresql
user = postgres

auth_type = hba
auth_hba_file = /etc/pgbouncer/pg_hba_[[ item.key ]].conf
auth_file = /etc/pgbouncer/userlist_[[ item.key ]].txt
auth_user = [[ item.value.pgbouncer_user | default('pgbouncer') ]]
auth_query = SELECT * FROM pgbouncer.get_auth($1)

admin_users = pgbouncer
stats_users = pgbouncer

pool_mode = session
default_pool_size = 20
max_client_conn = 100
