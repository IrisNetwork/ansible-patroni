---

- name: Install prereqs and patroni
  apt:
    update_cache: yes
    cache_valid_time: 3600
    state: latest
    name: "{{ patroni_prereqs }},{{ patroni_package }}"

- name: Ensure config directory exist
  file:
    path: /etc/patroni
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Ensure patroni log directory exist
  file:
    path: "{{ patroni_log_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: 0755
  with_dict:
    "{{ clusters_config }}"

- name: Ensure postgresql log directory exist, if necessary
  file:
    path: "{{ postgresql_log_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: 0755
  with_dict:
    "{{ clusters_config }}"

- name: Create patroni configuration
  template:
    src: patroni.j2
    dest: "/etc/patroni/{{ item.key }}.conf"
    owner: root
    group: root
    mode: 0644
  with_dict:
    "{{ clusters_config }}"

- name: Create needed directory
  file:
    path: "{{ item.value.path }}/postgresql"
    state: directory
    mode: 0700
    owner: postgres
    group: postgres
  with_dict:
    "{{ clusters_config }}"

- name: Create bootstrap script
  copy:
    src: bootstrap-pgbackrest
    dest: /usr/local/bin/bootstrap-pgbackrest
    group: root
    owner: root
    mode: 0755

- name: Disable and stop default systemd script
  systemd:
    name: patroni
    enabled: false
    state: stopped

- name: Create systemd init script
  template:
    src: systemd.j2
    dest: "/etc/systemd/system/patroni-{{ item.key }}.service"
    owner: root
    group: root
    mode: 0644
  with_dict:
    "{{ clusters_config }}"

- name: Enable and start systemd patroni scripts
  systemd:
    daemon_reload: yes
    name: "patroni-{{ item.key }}"
    enabled: true
    state: started
  with_dict:
    "{{ clusters_config }}"

- name: Wait for patroni server to start
  wait_for:
    host: "{{ ansible_host }}"
    port: "{{ item.value.port + 2000 }}"
    delay: 10
    timeout: 300
  with_dict:
    "{{ clusters_config }}"

- name: Apply tuning
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{Â item.value.port + 2000 }}/config"
    body: "{{ lookup('template','tuning.json') }}"
    body_format: json
    method: "PATCH"
    return_content: yes
  when: item.value.tuning is defined and item.value.tuning
  with_dict:
    "{{ clusters_config }}"
  run_once: true
